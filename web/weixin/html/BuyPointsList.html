
<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>购买运费券</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="../css/mui.min.css">
        <link href="../css/mui.picker.css" rel="stylesheet" />
		<link href="../css/mui.poppicker.css" rel="stylesheet" />
	</head>

	<body>
        <div class="mui-content">
		    <div class="mui-content-padded">
			    <button id='FromRoutePicker' class="mui-btn " type='button' style="width:35%;">起始地</button>
                <button id='ToRoutePicker' class="mui-btn" type='button' style="width:35%;">目的地</button>
                <button id="search" class="mui-btn mui-btn-primary ">点击搜索</button>
		    </div>
        </div>
		<!--下拉刷新容器-->
		<div id="pullrefresh" class="mui-content mui-scroll-wrapper" style="margin-top:50px;">
			<div class="mui-scroll">
				<!--数据列表-->
				<ul class="mui-table-view" id="data_list">
					
				</ul>
			</div>
		</div>
		<script src="../js/mui.min.js"></script>
        <script src="../js/app.js"></script>
        <script src="../js/mui.showLoading.js"></script>
        <script src="../js/mui.picker.js"></script>
		<script src="../js/mui.poppicker.js"></script>
        <script src="../js/city.data.js"></script>
		<script>
		    mui.init({
		        pullRefresh: {
		            container: '#pullrefresh',
		            up: {
		                contentrefresh: '正在加载...',
		                callback: pullupRefresh
		            }
		        }
		    });
		    var list;
		    var pagnum = 1;
		    var pagesize = 10;
		    var totalcount = 0;
		    var flag = false;

		    /**
			 * 上拉加载具体业务实现
			 */
		    function pullupRefresh() {
		        mui.showLoading("正在加载..", "div");
		        mui.ajax(grobal_url, {
		            dataType: "json",
		            type: "post",
		            data: {
		                "action": "PlatSaleList",
		                "UserName": localStorage.getItem("mgps_UserName"),
		                "pagnum": pagnum,
		                "pagesize": pagesize,
		                "FromRoute": document.getElementById('FromRoutePicker').textContent,
		                "ToRoute": document.getElementById('ToRoutePicker').textContent
		            },
		            success: function (data, status, xhr) {
		                if (data.sign == '1') {
		                    if (localStorage.getItem("PlatToSaleId"))
		                        localStorage.removeItem("PlatToSaleId");
		                    list = data.value.dt;
		                    pagnum = (data.value.cp + 1);
		                    totalcount = data.value.ac;
		                    if (totalcount <= (pagnum - 1) * pagesize) {
		                        flag = true;
		                    }
		                    setTimeout(function () {
		                        mui.hideLoading();
		                        mui('#pullrefresh').pullRefresh().endPullupToRefresh(flag); //参数为true代表没有更多数据了。
		                        var table = document.body.querySelector('.mui-table-view');
		                        for (var i = 0; i < list.length; i++) {
		                            var li = document.createElement('li');
		                            li.className = 'mui-table-view-cell';
		                            //li.innerHTML = '<a href="javascript:void(0);">'+
						            //                    '<img class="mui-media-object mui-pull-left" src="../images/cbd.jpg">'+
						            //                    '<div class="mui-media-body">'+
							        //                        'CBD'+
							        //                        '<p class="mui-ellipsis">烤炉模式的城，到黄昏，如同打翻的调色盘一般.</p>'+
						            //                    '</div>' +
                                    //                    '<div class="mui-table-cell mui-col-xs-2 mui-text-center">' +
                                    //                        '<br /><button type="button" class="mui-btn mui-btn-primary mui-btn-outlined" onClick="BuyPoints(\'' + list[i]["PlatToSaleId"] + '\');">' +
                                    //                            '购买' +
                                    //                        '</button>' +
                                    //                    '</div>' +
		                            //                '</a>';
		                            var isGZ = "关注";
		                            if (list[i]["GZ_ID"])
		                                isGZ = "已关注";
		                            li.innerHTML = '<div class="mui-table">' +
                                                        '<div class="mui-table-cell mui-col-xs-2" style="float:left;display: flex;">' +
                                                            '<img style="width:60px;height:60px;justify-content:center;align-items:Center;" src="../../files/' + list[i]["FJ_ID"] + "." + list[i]["FJ_MC"] + '">' +
                                                        '</div>'+
                                                        '<div class="mui-table-cell mui-col-xs-8" style="float:left;padding-left:10px;">' +
                                                            '<h5 style="line-height:150%;word-wrap:break-word;"><span style="color:blue;font-weight:bold;">' + list[i]["UserXM"] + '-</span><span style="color:red;font-weight:bold;">' + list[i]["points"] + '分</span>　<button type="button" style="padding:0px !important;border:0px !important;color:green !important;font-weight:bold;" onClick="GZWL(\'' + list[i]["UserID"] + '\');">' + isGZ + '</button></h5>' +
                                                            '<h5>折　扣：' + list[i]["discountmemo"] + '　(购买人数：<span style="color:red;">' + list[i]["num"] + '</span>)</h5>' +
                                                            '<h5 style="word-wrap:break-word;">线　路：' + list[i]["FromRoute"] + '-' + list[i]["ToRoute"] + '</h5>' +
                                                        '</div>' +
                                                        '<div class="mui-table-cell mui-col-xs-2 mui-text-center" style="float:right;padding-right:10px;">' +
                                                            '<br /><button type="button" class="mui-btn mui-btn-primary mui-btn-outlined" onClick="BuyPoints(\'' + list[i]["PlatToSaleId"] + '\');">' +
                                                                '购买' +
                                                            '</button>' +
                                                        '</div>' +
                                                   '</div>';
		                            table.appendChild(li);
		                        }
		                    }, 1500);
		                } else {
		                    mui.hideLoading();
		                    mui.alert(data.msg)
		                }
		            }
		        });
		    }
		    var cityPicker = new mui.PopPicker({
		        layer: 2
		    });
		    cityPicker.setData(cityData);
		    var showCityPickerButton = document.getElementById('FromRoutePicker');
		    showCityPickerButton.addEventListener('tap', function (event) {
		        cityPicker.show(function (items) {
		            showCityPickerButton.innerHTML = items[1].text;
		            //返回 false 可以阻止选择框的关闭
		            //return false;
		        });
		    }, false);

		    var cityPicker1 = new mui.PopPicker({
		        layer: 2
		    });
		    cityPicker1.setData(cityData);
		    var showCityPickerButton1 = document.getElementById('ToRoutePicker');
		    showCityPickerButton1.addEventListener('tap', function (event) {
		        cityPicker1.show(function (items) {
		            showCityPickerButton1.innerHTML = items[1].text;
		            //返回 false 可以阻止选择框的关闭
		            //return false;
		        });
		    }, false);

		    var searchButton = document.getElementById('search');
		    searchButton.addEventListener('tap', function (event) {
		        list;
		        pagnum = 1;
		        pagesize = 10;
		        totalcount = 0;
		        flag = false;
		        document.getElementById("data_list").innerHTML = "";
		        pullupRefresh();
		    }, false);

		    function GZWL(val)
		    {
		        var btnArray = ['否', '是'];
		        mui.confirm('是否关注该物流？', '提示', btnArray, function (e) {
		            if (e.index == 1) {
		                mui.ajax(grobal_url, {
		                    dataType: "json",
		                    type: "post",
		                    data: {
		                        "action": "GZWL",
		                        "UserName": localStorage.getItem("mgps_UserName"),
		                        "WLUser": val
		                    },
		                    success: function (data, status, xhr) {
		                        //ajax_sign = data.sign;
		                        //ajax_msg = data.msg;
		                        mui.alert(data.msg);
		                    }
		                });
		            }
		        })
		    }

		    function BuyPoints(val)
		    {
		        document.location.href = "BuyPointsDetails.html";
		        localStorage.setItem("PlatToSaleId", val);
		    }

		    if (mui.os.plus) {
		        mui.plusReady(function () {
		            setTimeout(function () {
		                mui('#pullrefresh').pullRefresh().pullupLoading();
		            }, 1000);

		        });
		    } else {
		        mui.ready(function () {
		            mui('#pullrefresh').pullRefresh().pullupLoading();
		        });
		    }
		</script>
	</body>

</html>